import streamlit as st
import plotly.graph_objects as go
import yfinance as yf
import FinanceDataReader as fdr
from datetime import datetime, timedelta
import pandas as pd

# âœ… ì„¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ê¸°ê°„ ë³€ê²½ ì‹œ ì¦‰ì‹œ ë°˜ì˜)
def update_period():
    st.session_state.selected_period = st.session_state.radio_selection

# âœ… 1. ìµœê·¼ ê±°ë˜ì¼ ì°¾ê¸° í•¨ìˆ˜
def get_recent_trading_day():
    today = datetime.now()
    if today.hour < 9:
        today -= timedelta(days=1)
    while today.weekday() in [5, 6]:  # í† ìš”ì¼(5), ì¼ìš”ì¼(6) ì œì™¸
        today -= timedelta(days=1)
    return today.strftime('%Y-%m-%d')

# âœ… 2. í‹°ì»¤ ì¡°íšŒ í•¨ìˆ˜
def get_ticker(company, source="yahoo"):
    try:
        listing = fdr.StockListing('KRX')
        ticker_row = listing[listing["Name"].str.strip() == company.strip()]
        if not ticker_row.empty:
            krx_ticker = str(ticker_row.iloc[0]["Code"]).zfill(6)
            return krx_ticker + ".KS" if source == "yahoo" else krx_ticker
        return None
    except Exception as e:
        st.error(f"í‹°ì»¤ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return None

# âœ… 3. ì•¼í›„ íŒŒì´ë‚¸ìŠ¤ì—ì„œ ë¶„ë´‰ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (1day, week)
def get_intraday_data_yahoo(ticker, period="1d", interval="1m"):
    try:
        stock = yf.Ticker(ticker)
        df = stock.history(period=period, interval=interval)
        if df.empty:
            return pd.DataFrame()
        df = df.reset_index()
        df = df.rename(columns={"Datetime": "Date", "Close": "Close",
                                "Open": "Open", "High": "High", "Low": "Low"})
        df["Date"] = pd.to_datetime(df["Date"])
        df = df[df["Date"].dt.weekday < 5].reset_index(drop=True)  # ì£¼ë§ ë°ì´í„° ì œê±°
        
        # âœ… 3ì‹œ 30ë¶„ê¹Œì§€ ë°ì´í„° í¬í•¨í•˜ë„ë¡ í•„í„° ì ìš©
        df = df[df["Date"].dt.time <= datetime.strptime("15:30:00", "%H:%M:%S").time()]
        
        return df
    except Exception as e:
        st.error(f"ì•¼í›„ íŒŒì´ë‚¸ìŠ¤ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: {e}")
        return pd.DataFrame()

# âœ… 4. FinanceDataReaderë¥¼ í†µí•œ ì¼ë³„ ì‹œì„¸ (1month, 1year)
def get_daily_stock_data_fdr(ticker, period):
    try:
        end_date = get_recent_trading_day()
        start_date = (datetime.strptime(end_date, '%Y-%m-%d') - timedelta(days=30 if period == "1month" else 365)).strftime('%Y-%m-%d')
        df = fdr.DataReader(ticker, start_date, end_date)
        if df.empty:
            return pd.DataFrame()
        df = df.reset_index()
        df = df.rename(columns={"Date": "Date", "Close": "Close"})
        df["Date"] = pd.to_datetime(df["Date"])
        df = df[df["Date"].dt.weekday < 5].reset_index(drop=True)  # ì£¼ë§ ì œê±°
        return df
    except Exception as e:
        st.error(f"FinanceDataReader ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: {e}")
        return pd.DataFrame()

# âœ… 5. Plotlyë¥¼ ì´ìš©í•œ ì£¼ê°€ ì‹œê°í™” í•¨ìˆ˜ (1day & weekë„ ìº”ë“¤ ì°¨íŠ¸ ì ìš©)
def plot_stock_plotly(df, company, period):
    if df is None or df.empty:
        st.warning(f"ğŸ“‰ {company} - í•´ë‹¹ ê¸°ê°„({period})ì˜ ê±°ë˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return

    fig = go.Figure()

    # âœ… xì¶• ë‚ ì§œ í˜•ì‹ ì„¤ì •
    if period == "1day":
        df["FormattedDate"] = df["Date"].dt.strftime("%H:%M")
    elif period == "week":
        df["FormattedDate"] = df["Date"].dt.strftime("%m-%d %H:%M")
    else:
        df["FormattedDate"] = df["Date"].dt.strftime("%m-%d")

    # âœ… ëª¨ë“  ê¸°ê°„(1day, week, 1month, 1year)ì—ì„œ ìº”ë“¤ ì°¨íŠ¸ ì ìš©
    fig.add_trace(go.Candlestick(
        x=df["FormattedDate"],
        open=df["Open"],
        high=df["High"],
        low=df["Low"],
        close=df["Close"],
        name="ìº”ë“¤ ì°¨íŠ¸"
    ))

    fig.update_layout(
        title=f"{company} ì£¼ê°€ ({period})",
        xaxis_title="ì‹œê°„" if period == "1day" else "ë‚ ì§œ",
        yaxis_title="ì£¼ê°€ (KRW)",
        template="plotly_white",
        xaxis=dict(showgrid=True, type="category", tickangle=-45),
        hovermode="x unified"
    )

    st.plotly_chart(fig)

# âœ… ì‹¤í–‰
def main():
    st.title("Stock Data Viewer")
    st.write("Welcome to the stock data visualization app.")

if __name__ == '__main__':
    main()
